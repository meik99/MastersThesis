\subsection{Get release information}\label{subsec:get-release-information}

This task is used to generate a changelog and collect metadata.
First, the branches SHA-hash is determined, by cloning the target repository and switching to the release branch, determined by the [find-latest-release-branch](../release%20tasks/find-latest-release-branch.md) task.
The bash command `git rev-parse "${branch}"` then returns the hash value, which is used later.

Then, the prefix for the Google Container Registry (GCR) is determined.
The task uses the GKE service account, read from a vault secret, to query the project name.
By adding the prefix `gcr.io/` and replacing colons with forward slashes, the registry for the image, which is built and uploaded in a later task, can be determined.
The project name depends on the marketplace that is set to be used.
It can be configured by changing the `gcp_marketplace` parameter in the [params-dev](../../params-dev.yaml) or [params-prod](../../params-prod.yaml) files.
Usually, these steps result in the prefix `gcr.io/{gcp_marketplace}`.

After the project name and the branch hash are determined, a python script is called.
It can be found in [/scripts/release/metadata/](../../scripts/release/metadata/__init__.py).
This script takes the following parameters.

| Parameter               | Expected value                                                                                                                                                                         | Default                        |
| ----------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------ |
| `--release-data`        | The path to the release data currently compiled by previous tasks.                                                                                                                     | `release-data/version`         |
| `--branch-sha`          | The release branches hash value as determined before.                                                                                                                                  |                                |
| `--github-token`        | A personal access token for GitHub. It should have the following scopes `admin:org, delete_repo, repo, workflow`. The same token can be used by multiple tasks if these scopes are set |                                |
| `--operator-repository` | The target repository from which the releases are queried                                                                                                                              | `Dynatrace/dynatrace-operator` |
| `--gke-registry`        | The name of the GCR registry for the GKE release step later on.                                                                                                                        |                                |
| `--gke-app-name`        | The name under which the DTO is released.                                                                                                                                              | `dynatrace-operator`           |

This script then proceeds to compile the given data, excluding the token and repository, together into a dictionary.
The descriptions for the GitHub and Helm releases are also added.
Both are hardcoded and can be found at [/scripts/release/metadata/descriptions.py](/../../scripts/release/metadata/descriptions.py).
It then uses the token to request a changelog for the given repository from the GitHub API.
Similarly to how [get-next-version](./get-next-version.md) requests releases, this script calls the `https://api.github.com/repos/{operator_repository}/releases/generate-notes` endpoint.
The generated changelog is then also appended to the resulting release data.

This task should then output the following JSON document.
```json
    {
    "branch": "<release-branch>",
    "version": "<next version to be release>",
    "csv_branch": "<branch on which to generate CSV files>",
    "helm_branch": "<branch on which to generate the Helm release>",
    "tag": "<the tag for the GitHub release>",
    "sha": "<hash of the release branch>",
    "release": {
        "changelog": "<Changelog generated by the GitHub API>",
        "description": "<Hardcoded description for the GitHub release>",
        "helm-chart-description": "<Hardcoded description for the Helm release>"
    },
    "gcr": {
        "registry": "<GCR registry as determined before>",
        "app-name": "dynatrace-operator",
        "version": "<next version to be release>",
        "image": "<GCR image name for the operator release>"
    }
}
```

## Purpose

This tasks main purpose is to get the generated changelogs from the GitHub API.
To do so, the GitHub API expects the branch hash to now for which commit to generate changelogs for.
Other information which is conveniently available is then also added to the resulting release data.
