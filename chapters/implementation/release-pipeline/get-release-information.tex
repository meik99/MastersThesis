\textbf{Get release information}

This task's main purpose is to get the generated changelogs from the GitHub API.
To do so, the GitHub API expects the branch hash to know for which commit to generate changelogs for.
All additional information is then also added to the resulting release data.

This task is used to generate a changelog and collect metadata.
First, the branches SHA-hash is determined, by cloning the target repository and switching to the release branch, that was determined by the task for finding the latest release branch.
The bash command \verb|git rev-parse "${branch}"| then returns the hash value, which is used later.

Then, the prefix for the Google Container Registry (GCR)\footnote{https://cloud.google.com/container-registry} is determined.
The task uses the GKE service account, that is retrieved from a vault secret, to query the project name.
By adding the prefix \verb|gcr.io/| and replacing colons with forward slashes, the registry for the image, which is built and uploaded in a later task, can be determined.
The project name depends on the set marketplace value.
It can be configured by changing the \verb|gcp_marketplace| parameter.
Usually, these steps result in the prefix \verb|gcr.io/{gcp_marketplace}|.

After the project name and the branch hash are determined, a python script is called.
This script takes the parameters shown in table~\ref{tab:params-to-generate-release-information}.

\begin{table}[h]
    \centering
    \caption{Parameters to generate release information}
    \label{tab:params-to-generate-release-information}
    \begin{tabular}{p{0.3\linewidth}|p{0.6\linewidth}}
        Parameter & Expected value \\
        \hline
        \verb| --release-data | & The path to the release data currently compiled by previous tasks.  \\
        \verb| --branch-sha | & The release branches hash value as determined before. \\
        \verb| --github-token | & A personal access token for GitHub.
            It should have the following scopes \verb|admin:org, delete_repo, repo, workflow|.
            The same token can be used by multiple tasks if these scopes are set \\
        \verb| --operator-repository | & The target repository from which the releases are queried \\
        \verb| --gke-registry | & The name of the GCR registry for the GKE release step later on. \\
        \verb| --gke-app-name | & The name under which the DTO is released. \\
    \end{tabular}
\end{table}

This script then proceeds to compile the given data, excluding the token and repository, together into a dictionary.
The descriptions for the GitHub and Helm releases are also added.
It then uses the token to request a changelog for the given repository from the GitHub API.
Similarly to how the task to get the next version requests releases, this script calls the \url{https://api.github.com/repos/<operator_repository>/releases/generate-notes} endpoint.
The generated changelog is then also appended to the resulting release data.
This task should then output the following JSON document.

\begin{verbatim}
{
    "branch": "<release-branch>",
    "version": "<next version to be release>",
    "csv_branch": "<branch on which to generate CSV files>",
    "helm_branch": "<branch on which to generate the Helm release>",
    "tag": "<the tag for the GitHub release>",
    "sha": "<hash of the release branch>",
    "release": {
        "changelog": "<Changelog generated by the GitHub API>",
        "description": "<Hardcoded description for the GitHub release>",
        "helm-chart-description": "<Hardcoded description for the Helm release>"
    },
    "gcr": {
        "registry": "<GCR registry as determined before>",
        "app-name": "dynatrace-operator",
        "version": "<next version to be release>",
        "image": "<GCR image name for the operator release>"
    }
}
\end{verbatim}
